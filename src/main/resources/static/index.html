<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Biblioteca UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, Arial, sans-serif; margin: 24px; display: flex; flex-direction: column; gap: 32px;}
        section, details { border: 1px solid #ddd; padding: 16px; border-radius: 8px; }
        details { margin-bottom: 16px; }
        form { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 16px; }
        form > div { display: flex; flex-direction: column; }
        input, button { padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; }
        button.secondary { background-color: #6c757d; border-color: #6c757d; }
        button:hover { opacity: 0.9; }
        table { border-collapse: collapse; width: 100%; margin-top: 16px; }
        th, td { border: 1px solid #ddd; padding: 8px; vertical-align: middle; text-align: left; }
        th { background: #f6f6f6; }
        .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .muted { color: #666; font-size: 12px; }
        .error { color: #b00020; }
        .success { color: #0a7a0a; }
        hr { width: 100%; border: 1px solid #eee; margin: 24px 0;}
        .cover-image { max-width: 60px; height: auto; border-radius: 4px; }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 8px; align-items: center; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag-badge { background-color: #e9ecef; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer; transition: background-color 0.2s; }
        .tag-badge:hover { background-color: #ced4da; }
    </style>
</head>
<body>
<h1>Gestão da Biblioteca</h1>

<section id="usersSection">
    <h2>Usuários</h2>
    <details>
        <summary><strong>Criar novo usuário</strong></summary>
        <form id="createUserForm" style="grid-template-columns: 1fr;">
            <div><label for="ra">RA</label><input id="ra" required /></div>
            <div><label for="nome">Nome</label><input id="nome" required /></div>
            <div><label for="senha">Senha</label><input id="senha" type="password" required /></div>
            <div class="form-actions">
                <button type="submit">Criar Usuário</button>
                <span id="createUserMsg" class="muted"></span>
            </div>
        </form>
    </details>
    <h3>Todos os Usuários</h3>
    <div id="listUsersMsg" class="muted"></div>
    <table id="usersTable">
        <thead>
        <tr><th>ID</th><th>RA</th><th>Nome</th><th>Criado em</th><th>Atualizado em</th><th>Atualizar (nome/senha)</th><th>Ações</th></tr>
        </thead>
        <tbody id="usersBody"></tbody>
    </table>
</section>

<hr />

<section id="livrosSection">
    <h2 id="livroFormTitle">Cadastrar Novo Livro</h2>
    <form id="createLivroForm">
        <div><label for="tituloLivro">Título</label><input id="tituloLivro" required /></div>
        <div><label for="autorLivro">Autor</label><input id="autorLivro" required /></div>
        <div><label for="generoLivro">Gênero / Categoria</label><input id="generoLivro" /></div>
        <div><label for="anoLivro">Ano de Publicação</label><input id="anoLivro" type="number" min="1800"/></div>
        <div><label for="qtdLivro">Quantidade Disponível</label><input id="qtdLivro" type="number" min="0" required /></div>
        <div><label for="isbnLivro">ISBN</label><input id="isbnLivro" /></div>
        <div><label for="tagsLivro">Tags (separadas por vírgula)</label><input id="tagsLivro" /></div>
        <div><label for="imagemCapaLivro">Imagem da Capa</label><input id="imagemCapaLivro" type="file" accept="image/*" /></div>
        <div class="form-actions">
            <button type="submit">Cadastrar Livro</button>
            <span id="createLivroMsg" class="muted"></span>
        </div>
    </form>

    <h3 style="margin-top: 24px;">Todos os Livros</h3>

    <form id="searchLivroForm" style="display: flex; gap: 8px; margin-bottom: 16px; grid-template-columns: 1fr auto auto;">
        <input id="searchLivroInput" placeholder="Buscar por título, autor, gênero..." style="flex-grow: 1;"/>
        <button type="submit">Buscar</button>
        <button type="button" id="clearSearchBtn" class="secondary">Limpar</button>
    </form>

    <div id="listLivrosMsg" class="muted"></div>
    <table id="livrosTable">
        <thead>
        <tr><th>Capa</th><th>ID</th><th>Título</th><th>Autor</th><th>Gênero</th><th>Tags</th><th>Ações</th></tr>
        </thead>
        <tbody id="livrosBody"></tbody>
    </table>
</section>

<script>
    // ==================================================================
    // ||               LÓGICA E FUNÇÕES PARA USUÁRIOS                 ||
    // ==================================================================

    // Objeto para chamadas à API de usuários
    const apiUsuario = { base: '/usuario', async list() { const res = await fetch(this.base); if (!res.ok) throw new Error(`List failed: ${res.status}`); return res.json(); }, async create(payload) { const res = await fetch(this.base, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (res.status !== 201) throw new Error(`Create failed: ${res.status}`); }, async update(id, payload) { const res = await fetch(`${this.base}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (res.status !== 204) throw new Error(`Update failed: ${res.status}`); }, async remove(id) { const res = await fetch(`${this.base}/${id}`, { method: 'DELETE' }); if (res.status !== 204) throw new Error(`Delete failed: ${res.status}`); } };

    // Referências aos elementos HTML da seção de usuários
    const elsUsuario = { createForm: document.getElementById('createUserForm'), ra: document.getElementById('ra'), nome: document.getElementById('nome'), senha: document.getElementById('senha'), createMsg: document.getElementById('createUserMsg'), listMsg: document.getElementById('listUsersMsg'), usersBody: document.getElementById('usersBody') };

    // Cria os inputs de atualização para uma linha da tabela de usuários
    function rowUpdateInputs(user) { const w = document.createElement('div'), n = document.createElement('input'), p = document.createElement('input'), b = document.createElement('button'); n.placeholder = 'Novo nome'; p.placeholder = 'Nova senha'; p.type = 'password'; b.textContent = 'Atualizar'; b.onclick = async () => { const payload = {}; if (n.value.trim()) payload.usuarioNome = n.value.trim(); if (p.value.trim()) payload.usuarioSenha = p.value.trim(); if (Object.keys(payload).length === 0) return; try { await apiUsuario.update(user.usuarioId, payload); await loadUsers(); } catch (e) { alert(e.message); } }; w.append(n, document.createElement('br'), p, document.createElement('br'), b); return w; }

    // Renderiza a tabela de usuários com os dados da API
    function renderUsers(users) { elsUsuario.usersBody.innerHTML = ''; for (const u of users) { const tr = document.createElement('tr'), tdId = document.createElement('td'), tdRa = document.createElement('td'), tdNome = document.createElement('td'), tdCreated = document.createElement('td'), tdUpdated = document.createElement('td'), tdUpdate = document.createElement('td'), tdActions = document.createElement('td'); tdId.textContent = u.usuarioId; tdRa.textContent = u.usuarioRA; tdNome.textContent = u.usuarioNome; tdCreated.textContent = new Date(u.creationTimestamp).toLocaleString(); tdUpdated.textContent = new Date(u.updateTimestamp).toLocaleString(); tdUpdate.appendChild(rowUpdateInputs(u)); tdActions.className = 'row-actions'; const delBtn = document.createElement('button'); delBtn.textContent = 'Deletar'; delBtn.onclick = async () => { if (!confirm('Deletar este usuário?')) return; try { await apiUsuario.remove(u.usuarioId); await loadUsers(); } catch (e) { alert(e.message); } }; const viewBtn = document.createElement('button'); viewBtn.textContent = 'Ver JSON'; viewBtn.onclick = async () => { try { const res = await fetch(`/usuario/${u.usuarioId}`); if (!res.ok) throw new Error(`View failed: ${res.status}`); alert(JSON.stringify(await res.json(), null, 2)); } catch (e) { alert(e.message); } }; tdActions.append(viewBtn, delBtn); tr.append(tdId, tdRa, tdNome, tdCreated, tdUpdated, tdUpdate, tdActions); elsUsuario.usersBody.appendChild(tr); } }

    // Carrega a lista de usuários da API e chama a função de renderização
    async function loadUsers() { elsUsuario.listMsg.textContent = 'Carregando...'; try { const users = await apiUsuario.list(); renderUsers(users); elsUsuario.listMsg.textContent = `${users.length} usuário(s)`; } catch (e) { elsUsuario.listMsg.textContent = ''; alert(e.message); } }

    // Listener para o formulário de criação de usuário
    elsUsuario.createForm.addEventListener('submit', async (e) => { e.preventDefault(); elsUsuario.createMsg.textContent = ''; const payload = { usuarioRA: elsUsuario.ra.value.trim(), usuarioNome: elsUsuario.nome.value.trim(), usuarioSenha: elsUsuario.senha.value.trim() }; if (!payload.usuarioRA || !payload.usuarioNome || !payload.usuarioSenha) { elsUsuario.createMsg.textContent = 'Todos os campos são obrigatórios.'; elsUsuario.createMsg.className = 'error'; return; } try { await apiUsuario.create(payload); elsUsuario.createMsg.textContent = 'Criado.'; elsUsuario.createMsg.className = 'success'; elsUsuario.createForm.reset(); await loadUsers(); } catch (e2) { elsUsuario.createMsg.textContent = e2.message; elsUsuario.createMsg.className = 'error'; } });


    // ==================================================================
    // ||                LÓGICA E FUNÇÕES PARA LIVROS                  ||
    // ==================================================================

    // Objeto para chamadas à API de livros
    const apiLivro = { base: '/livro', async list() { const res = await fetch(this.base); if (!res.ok) throw new Error(`Falha ao listar livros: ${res.status}`); return res.json(); }, async getById(id) { const res = await fetch(`${this.base}/${id}`); if (!res.ok) throw new Error(`Falha ao buscar livro: ${res.status}`); return res.json(); }, async create(formData) { const res = await fetch(this.base, { method: 'POST', body: formData }); if (res.status !== 201) { throw new Error(`Falha ao criar livro: ${res.status}`); } }, async update(id, formData) { const res = await fetch(`${this.base}/${id}`, { method: 'PUT', body: formData }); if (res.status !== 204) throw new Error(`Falha ao atualizar livro: ${res.status}`); }, async remove(id) { const res = await fetch(`${this.base}/${id}`, { method: 'DELETE' }); if (res.status !== 204) throw new Error(`Falha ao deletar livro: ${res.status}`); } };

    // Referências aos elementos HTML da seção de livros
    const elsLivro = { form: document.getElementById('createLivroForm'), formTitle: document.getElementById('livroFormTitle'), formActions: document.querySelector('#createLivroForm .form-actions'), submitButton: document.querySelector('#createLivroForm button[type="submit"]'), titulo: document.getElementById('tituloLivro'), autor: document.getElementById('autorLivro'), genero: document.getElementById('generoLivro'), ano: document.getElementById('anoLivro'), quantidade: document.getElementById('qtdLivro'), isbn: document.getElementById('isbnLivro'), tags: document.getElementById('tagsLivro'), imagem: document.getElementById('imagemCapaLivro'), createMsg: document.getElementById('createLivroMsg'), listMsg: document.getElementById('listLivrosMsg'), livrosBody: document.getElementById('livrosBody') };

    /**
     * Renderiza a tabela de livros com os dados vindos da API.
     * @param {Array} livros - Um array de objetos de livro.
     */
    function renderLivros(livros) {
        elsLivro.livrosBody.innerHTML = ''; // Limpa a tabela antes de preencher
        for (const livro of livros) {
            const tr = document.createElement('tr');

            // Função auxiliar para criar células <td>
            const createCell = (content) => {
                const td = document.createElement('td');
                if (typeof content === 'string' || typeof content === 'number') {
                    td.textContent = content ?? ''; // Previne 'null' ou 'undefined' de aparecerem
                } else {
                    td.appendChild(content); // Se for um elemento HTML (como a imagem ou os botões)
                }
                return td;
            };

            // Cria a imagem da capa
            const coverImg = document.createElement('img');
            coverImg.src = livro.caminhoImagemCapa ? `/uploads/${livro.caminhoImagemCapa}` : 'https://via.placeholder.com/60x80.png?text=Capa';
            coverImg.alt = `Capa de ${livro.titulo}`;
            coverImg.className = 'cover-image';

            // Cria as tags clicáveis
            const tdTags = document.createElement('td');
            const tagContainer = document.createElement('div');
            tagContainer.className = 'tag-container';
            if (livro.tags && livro.tags.trim() !== '') {
                const tagsArray = livro.tags.split(',');
                tagsArray.forEach(tag => {
                    const tagText = tag.trim();
                    if (tagText) {
                        const tagBadge = document.createElement('span');
                        tagBadge.className = 'tag-badge';
                        tagBadge.textContent = tagText;
                        tagBadge.onclick = () => searchByTag(tagText); // Adiciona o evento de clique
                        tagContainer.appendChild(tagBadge);
                    }
                });
            }
            tdTags.appendChild(tagContainer);

            // Cria os botões de ação (Ver JSON, Editar, Deletar)
            const tdActions = document.createElement('td');
            tdActions.className = 'row-actions';
            const viewBtn = document.createElement('button'); viewBtn.textContent = 'Ver JSON'; viewBtn.onclick = async () => { try { alert(JSON.stringify(await apiLivro.getById(livro.livroId), null, 2)); } catch (e) { alert(e.message); }};
            const editBtn = document.createElement('button'); editBtn.textContent = 'Editar'; editBtn.onclick = () => prepareFormForUpdate(livro.livroId);
            const delBtn = document.createElement('button'); delBtn.textContent = 'Deletar'; delBtn.onclick = async () => { if (!confirm(`Deletar o livro "${livro.titulo}"?`)) return; try { await apiLivro.remove(livro.livroId); await loadLivros(); } catch (e) { alert(e.message); }};
            tdActions.append(viewBtn, editBtn, delBtn);

            // Adiciona todas as células na linha
            tr.append( createCell(coverImg), createCell(livro.livroId), createCell(livro.titulo), createCell(livro.autor), createCell(livro.genero), tdTags, createCell(tdActions) );

            // Adiciona a linha na tabela
            elsLivro.livrosBody.appendChild(tr);
        }
    }

    /**
     * Carrega os dados de um livro no formulário principal para edição.
     * @param {string} id - O UUID do livro a ser editado.
     */
    async function prepareFormForUpdate(id) {
        try {
            const livro = await apiLivro.getById(id);
            resetFormToCreateMode(); // Limpa o formulário antes de preencher
            elsLivro.titulo.value = livro.titulo; elsLivro.autor.value = livro.autor; elsLivro.genero.value = livro.genero ?? ''; elsLivro.ano.value = livro.anoPublicacao ?? ''; elsLivro.quantidade.value = livro.quantidadeDisponivel ?? ''; elsLivro.isbn.value = livro.isbn ?? ''; elsLivro.tags.value = livro.tags ?? '';
            elsLivro.formTitle.textContent = `Editando Livro: ${livro.titulo}`;
            elsLivro.submitButton.textContent = 'Salvar Alterações';
            const hiddenId = document.createElement('input'); hiddenId.type = 'hidden'; hiddenId.id = 'livroIdUpdate'; hiddenId.value = livro.livroId;
            elsLivro.form.prepend(hiddenId);
            const cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.id = 'cancelUpdateBtn'; cancelBtn.textContent = 'Cancelar Edição'; cancelBtn.className = 'secondary'; cancelBtn.onclick = resetFormToCreateMode;
            elsLivro.formActions.appendChild(cancelBtn);
            elsLivro.form.scrollIntoView({ behavior: 'smooth' });
        } catch (e) { alert(e.message); }
    }

    /**
     * Reseta o formulário para o modo de criação, limpando campos e restaurando botões.
     */
    function resetFormToCreateMode() {
        elsLivro.form.reset();
        elsLivro.formTitle.textContent = 'Cadastrar Novo Livro';
        elsLivro.submitButton.textContent = 'Cadastrar Livro';
        document.getElementById('livroIdUpdate')?.remove();
        document.getElementById('cancelUpdateBtn')?.remove();
        elsLivro.createMsg.textContent = '';
    }

    /**
     * Carrega a lista completa de livros da API e chama a função para renderizar a tabela.
     */
    async function loadLivros() {
        elsLivro.listMsg.textContent = 'Carregando...';
        try {
            const livros = await apiLivro.list();
            renderLivros(livros); // <<<<<<<<<<< LINHA CORRIGIDA
            elsLivro.listMsg.textContent = `${livros.length} livro(s)`;
        } catch (e) {
            elsLivro.listMsg.textContent = '';
            alert(e.message);
        }
    }

    // Listener principal para o formulário de livros (lida com criação e atualização)
    elsLivro.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        elsLivro.createMsg.textContent = '';
        const idToUpdate = document.getElementById('livroIdUpdate')?.value;
        const livroDto = { titulo: elsLivro.titulo.value.trim(), autor: elsLivro.autor.value.trim(), genero: elsLivro.genero.value.trim(), anoPublicacao: elsLivro.ano.value ? parseInt(elsLivro.ano.value) : null, quantidadeDisponivel: elsLivro.quantidade.value ? parseInt(elsLivro.quantidade.value) : 0, isbn: elsLivro.isbn.value.trim(), tags: elsLivro.tags.value.trim() };
        if (!livroDto.titulo || !livroDto.autor) { elsLivro.createMsg.textContent = 'Título e Autor são obrigatórios.'; elsLivro.createMsg.className = 'error'; return; }
        const formData = new FormData();
        formData.append('livroDto', new Blob([JSON.stringify(livroDto)], { type: 'application/json' }));
        if (elsLivro.imagem.files[0]) { formData.append('imagem', elsLivro.imagem.files[0]); }
        try {
            if (idToUpdate) {
                await apiLivro.update(idToUpdate, formData);
                elsLivro.createMsg.textContent = 'Livro atualizado com sucesso.';
            } else {
                await apiLivro.create(formData);
                elsLivro.createMsg.textContent = 'Livro cadastrado com sucesso.';
            }
            elsLivro.createMsg.className = 'success';
            resetFormToCreateMode();
            await loadLivros();
        } catch (e2) {
            elsLivro.createMsg.textContent = e2.message;
            elsLivro.createMsg.className = 'error';
        }
    });

    // ==================================================================
    // ||               LÓGICA E FUNÇÕES PARA A BUSCA                  ||
    // ==================================================================

    const searchForm = document.getElementById('searchLivroForm');
    const searchInput = document.getElementById('searchLivroInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    // Listener para a busca geral (pelo input de texto)
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const termo = searchInput.value.trim();
        if (!termo) { await loadLivros(); return; }
        elsLivro.listMsg.textContent = `Buscando por "${termo}"...`;
        try {
            const res = await fetch(`/livro/buscar?termo=${encodeURIComponent(termo)}`);
            if (!res.ok) throw new Error('Falha na busca.');
            const livros = await res.json();
            renderLivros(livros);
            elsLivro.listMsg.textContent = `${livros.length} livro(s) encontrados para "${termo}"`;
        } catch (e) { alert(e.message); }
    });

    // Listener para o botão de limpar a busca
    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        loadLivros();
    });

    /**
     * Executa uma busca específica por uma tag clicada.
     * @param {string} tag - A tag a ser pesquisada.
     */
    async function searchByTag(tag) {
        searchInput.value = tag;
        elsLivro.listMsg.textContent = `Buscando pela tag "${tag}"...`;
        try {
            const res = await fetch(`/livro/buscar-por-tag?tag=${encodeURIComponent(tag)}`);
            if (!res.ok) throw new Error('Falha na busca por tag.');
            const livros = await res.json();
            renderLivros(livros);
            elsLivro.listMsg.textContent = `${livros.length} livro(s) encontrados com a tag "${tag}"`;
        } catch (e) { alert(e.message); }
    }
    document.getElementById('anoLivro').max = new Date().getFullYear();
    // ==================================================================
    // ||                   INICIALIZAÇÃO DA PÁGINA                    ||
    // ==================================================================

    loadUsers();
    loadLivros();

</script>
</body>
</html>